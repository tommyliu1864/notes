

# 通用权限系统：其他功能

## 一、日志管理

### 1、登录日志

#### 1.1、页面效果

![image-20221009153655567](images\image-20221009153655567.png)

#### 1.2、功能实现-登录成功添加日志

##### 1.2.1、在spring-security模块创建SysLoginLogService

```java
public interface SysLoginLogService extends IService<SysLoginLog> {
}
```

##### 1.2.2、实现添加日志方法

```java
@Service
public class SysLoginLogServiceImpl extends ServiceImpl<SysLoginLogMapper, SysLoginLog> implements SysLoginLogService {
}
```

##### 1.2.3、在SecurityLoginFilter调用方法实现

```java
// 登录成功，生成token并返回
@Override
protected void successfulAuthentication(HttpServletRequest request, HttpServletResponse response, FilterChain chain, Authentication authResult) throws IOException, ServletException {
    SecurityUser user = (SecurityUser) authResult.getPrincipal();
    String token = JwtHelper.createToken(user.getSysUser().getId(), user.getSysUser().getUsername());
    Map<String, String> map = new HashMap<>();
    map.put("token", token);
    // 权限数据保存到redis中，后续需要使用
    redisTemplate.opsForValue().set(user.getUsername(), JSON.toJSONString(user.getAuthorities()));
    log.debug("authorities to redis:" + JSON.toJSONString(user.getAuthorities()));
    // 保存登录成功日志
    SysLoginLog loginLog = new SysLoginLog(user.getUsername(), IpUtil.getIpAddress(request), 1, "登录成功");
    sysLoginLogService.save(loginLog);
    ResponseUtil.out(response, Result.ok(map));
}
```



#### 1.3、功能实现-登录日志显示

编写SysLoginLogController

```java
@Api(tags = "系统登录日志")
@RestController
@RequestMapping("/admin/system/sysLoginLog")
public class SysLoginLogController {

    @Autowired
    private SysLoginLogService sysLoginLogService;

    @PreAuthorize("hasAuthority('bnt.sysLoginLog.list')")
    @ApiOperation("条件分页查询")
    @GetMapping("{currentPage}/{pageSize}")
    public Result page(
            @ApiParam(value = "当前页", required = true) @PathVariable int currentPage,
            @ApiParam(value = "每页的数据条数", required = true) @PathVariable int pageSize,
            SysLoginLogQueryVO vo
    ) {
        IPage page = new Page(currentPage, pageSize);
        LambdaQueryWrapper<SysLoginLog> wrapper = new QueryWrapper<SysLoginLog>().lambda()
                .like(StringUtils.hasText(vo.getUsername()), SysLoginLog::getUsername, vo.getUsername())
                .ge(StringUtils.hasText(vo.getCreateTimeBegin()), SysLoginLog::getCreateTime, vo.getCreateTimeBegin())
                .le(StringUtils.hasText(vo.getCreateTimeEnd()), SysLoginLog::getCreateTime, vo.getCreateTimeEnd())
                .orderByDesc(SysLoginLog::getCreateTime);
        IPage pages = sysLoginLogService.page(page, wrapper);
        return Result.ok(pages);
    }
```

#### 1.4、登录日志前端

实现方式参考菜单管理



### 2、操作日志

#### 2.1、页面效果

![image-20221009153740885](images\image-20221009153740885.png)

#### 2.2、引入依赖

service-system 模块引入AOP依赖

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-aop</artifactId>
    </dependency>
</dependencies>
```

#### 2.3、创建AOP类LogAspect

```java
@Slf4j
@Aspect
@Component
/**
 * 操作日志的AOP处理
 */
public class LogAspect {

    @Autowired
    private SysOperLogService sysOperLogService;

    // 操作成功日志记录，这里我们复用swagger文档的注解信息，作为日志的部分信息
    @AfterReturning(pointcut = "@annotation(apiOperation)", returning = "result")
    public void doSucceedLog(JoinPoint joinPoint, ApiOperation apiOperation, Object result) {
        SysOperLog sysOperLog = buildLog(joinPoint, apiOperation, JSON.toJSONString(result), 1, null);
        sysOperLogService.save(sysOperLog);
    }

    // 操作异常，日志记录
    @AfterThrowing(pointcut = "@annotation(apiOperation)", throwing = "e")
    public void doFailedLog(JoinPoint joinPoint, ApiOperation apiOperation, Exception e) {
        // 消息太长，截断处理
        String errorMsg = substring(e.getMessage(), 500);
        SysOperLog sysOperLog = buildLog(joinPoint, apiOperation, null, 0, errorMsg);
        sysOperLogService.save(sysOperLog);
    }

    /**
     * 创建日志对象
     *
     * @param joinPoint
     * @param apiOperation
     * @param result
     * @return
     */
    private SysOperLog buildLog(
            JoinPoint joinPoint,
            ApiOperation apiOperation,
            String result,
            int status,
            String errorMsg) {
        SysOperLog log = new SysOperLog();
        // 模块注释
        Api api = joinPoint.getTarget().getClass().getAnnotation(Api.class);
        log.setModule(String.join(",", api.tags()));
        // 方法注释
        log.setTitle(apiOperation.value());
        // 方法名称
        String method = joinPoint.getTarget().getClass().getName() + "." + joinPoint.getSignature().getName();
        log.setMethod(method);
        RequestAttributes ra = RequestContextHolder.getRequestAttributes();
        ServletRequestAttributes sra = (ServletRequestAttributes) ra;
        HttpServletRequest request = sra.getRequest();
        // 用户名
        String token = request.getHeader("token");
        String username = JwtHelper.getUsername(token);
        log.setUsername(username);
        // ip
        String ip = IpUtil.getIpAddress(request);
        log.setIpaddr(ip);
        log.setStatus(status);
        log.setErrorMsg(errorMsg);

        // 请求参数
        Object[] args = joinPoint.getArgs();
        if (args != null) {
            String param = argsArrayToString(args);
            // 如果参数太长，截断处理
            log.setParam(substring(param, 1500));
        }

        // 只有修改操作，才保存返回值，因为查询操作的返回值太多了
        String requestMethod = request.getMethod();
        if (HttpMethod.PUT.name().equals(requestMethod)
                || HttpMethod.POST.name().equals(requestMethod)
                || HttpMethod.DELETE.name().equals(requestMethod)) {
            // 方法返回值
            if (result != null) {
                log.setResult(result);
            }
        }
        return log;
    }


    /**
     * 将请求参数拼接为JSON字符串
     *
     * @param paramsArray
     * @return
     */
    private String argsArrayToString(Object[] paramsArray) {
        String params = "";
        if (paramsArray != null && paramsArray.length > 0) {
            for (Object o : paramsArray) {
                if (!StringUtils.isEmpty(o) && !isFilterObject(o)) {
                    try {
                        Object jsonObj = JSON.toJSON(o);
                        params += jsonObj.toString() + " ";
                    } catch (Exception e) {
                    }
                }
            }
        }
        return params.trim();
    }

    /**
     * 判断是否需要过滤的对象。
     *
     * @param o 对象信息。
     * @return 如果是需要过滤的对象，则返回true；否则返回false。
     */
    @SuppressWarnings("rawtypes")
    public boolean isFilterObject(final Object o) {
        Class<?> clazz = o.getClass();
        if (clazz.isArray()) {
            return clazz.getComponentType().isAssignableFrom(MultipartFile.class);
        } else if (Collection.class.isAssignableFrom(clazz)) {
            Collection collection = (Collection) o;
            for (Object value : collection) {
                return value instanceof MultipartFile;
            }
        } else if (Map.class.isAssignableFrom(clazz)) {
            Map map = (Map) o;
            for (Object value : map.entrySet()) {
                Map.Entry entry = (Map.Entry) value;
                return entry.getValue() instanceof MultipartFile;
            }
        }
        return o instanceof MultipartFile || o instanceof HttpServletRequest || o instanceof HttpServletResponse
                || o instanceof BindingResult;
    }

    /**
     * 截取字符串
     *
     * @param str
     * @param length 超出指定长度范围，才截取字符串
     * @return 被截断的字符串
     */
    public String substring(String str, int length) {
        if (str.length() > length) {
            return str.substring(0, length);
        }
        return str;
    }

}
```

#### 2.4、操作日志显示

编写SysOperLogController

```java
@Api(tags = "系统操作日志")
@RestController
@RequestMapping("/admin/system/sysOperLog")
public class SysOperLogController {

    @Autowired
    private SysOperLogService sysOperLogService;

    @PreAuthorize("hasAuthority('bnt.sysOperLog.list')")
    @ApiOperation("条件分页查询")
    @GetMapping("{currentPage}/{pageSize}")
    public Result page(
            @ApiParam(value = "当前页", required = true) @PathVariable int currentPage,
            @ApiParam(value = "每页的数据条数", required = true) @PathVariable int pageSize,
            SysOperLogQueryVO vo
    ) {
        IPage page = new Page(currentPage, pageSize);
        LambdaQueryWrapper<SysOperLog> wrapper = new QueryWrapper<SysOperLog>().lambda()
                .like(StringUtils.hasText(vo.getUsername()), SysOperLog::getUsername, vo.getUsername())
                .ge(StringUtils.hasText(vo.getCreateTimeBegin()), SysOperLog::getCreateTime, vo.getCreateTimeBegin())
                .le(StringUtils.hasText(vo.getCreateTimeEnd()), SysOperLog::getCreateTime, vo.getCreateTimeEnd())
                .orderByDesc(SysOperLog::getCreateTime);
        IPage pages = sysOperLogService.page(page, wrapper);
        return Result.ok(pages);
    }

}
```

#### 2.5、操作日志前端

实现方式参考登录日志

## 二、前端部署

#### 2.1、修改配置

修改vue.config.js

```js
proxy: {
    '/prod-api': { // 匹配所有以 '/prod-api'开头的请求路径
        target: 'http://localhost:8080',
            changeOrigin: true, // 支持跨域
                pathRewrite: { // 重写路径: 去掉路径中开头的'/dev-api'
                    '^/prod-api': ''
                }
    }
}
```

#### 2.2、打包命令

```shell
npm run build:prod
```

#### 2.3、nginx配置

将build出来的前端代码拷贝到nginx的html目录下，并修改nginx.conf文件

```nginx
location /prod-api/ {
    proxy_pass	http://localhost:8080/;
}
```

